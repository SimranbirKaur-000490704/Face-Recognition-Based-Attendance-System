<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Attendance Page</title>
      <style>
         body {
            margin: 0;
            padding: 0;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
         }
      
         .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Remove overflow to allow content to expand */
            background-color: #f5f5f5;
            transition: transform 0.2s ease;
         }
      
         .container:hover {
            transform: scale(1.02); /* Slight scale on hover */
         }
      
         .container.expand {
            max-width: 100%;
            width: 400px;
            transition: max-width 0.5s ease, width 0.5s ease;
         }
      
         .box-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
         }
      
         .webcam-feed {
            width: 500px;
            height: 500px;
            background-color: lightgrey;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
         }
      
         .webcam-feed:hover {
            background-color: #dcdcdc; /* Lighten color on hover */
         }
      
         .button {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
         }
      
         .button:hover {
            background-color: #1769aa; /* Darker blue on hover */
         }
      
         .label {
            font-family: 'Roboto', sans-serif; /* Example font family */
            font-size: 24px;
            margin-bottom: 10px;
         }
      
         .video-container {
            text-align: center;
            height: fit-content;
            width: fit-content;
            max-width: 600px;
            max-height: 600px;
         }
          
         /* Media query for smaller screens */
         @media (max-width: 768px) {
         .container {
           max-width: 300px;
         }
         .webcam-feed, .video-container {
            width: 100%;
            }
         }
      </style>
   </head>
<body>
    <div class="container">
        <div class="box-container">
            <h2 class="label" id="responseLabel" >Ready, and Click!</h2>
            <div id="video-container" class="video-container">
            <img id="webcam-feed" src="/open-webcam1" alt="Webcam Feed" width="100%" height="100%">
            </div>
            <!-- Button to take attendance -->
            <button id="submit" class="button">Mark Attendance</button>
            <!-- Added new -->
            <!--label id="responseLabel" /--> 
        </div>
    </div>
    <!--script>
        function startWebcam(url) {
            window.location.href = url;

            // Add code here to start webcam
           // window.alert('Its a match! Your attendence is submitted');
           // event.preventDefault();
            //window.history.back();
        }
    </script-->
    <script>
        // Expand box-container when the page loads
        window.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('container');
            const boxContainer = document.getElementById('box-container');
            container.classList.add('expand'); // Add class to expand the container
            boxContainer.style.transitionDelay = '0.5s'; // Delay transition for box container
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const captureButton = document.getElementById('submit');
            const webcamFeed = document.getElementById('webcam-feed');

            captureButton.addEventListener('click', async () => {
                const canvas = document.createElement('canvas');
                canvas.width = webcamFeed.width;
                canvas.height = webcamFeed.height;
                const context = canvas.getContext('2d');
                context.drawImage(webcamFeed, 0, 0, canvas.width, canvas.height);

                const dataURL = canvas.toDataURL('image/jpeg');

                // Create JSON object with image data and form data
                const jsonData = {
                    image_data: dataURL,
                };

                try {
                    // Send JSON data to server to save the image
                    const response = await fetch('/save_attendence', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(jsonData)
                    });
                    const responseData = await response.json();
                    
                    // Access and display the name if available in the response
                    if (responseData) {
                        //const responseLabel = document.getElementById('responseLabel');
                        showConfirmation(`${responseData.name}`,`${responseData.id}` )

                    } else {
                        responseLabel.innerText = '';
                    }

                } catch (error) {
                    console.error('Error:', error);
                    alert('Please check the lighting and distance from the camera, Try again!');
                }
            });
        });
    </script>
    <script>
        function showConfirmation(name, id) {
            const confirmed = confirm(`Confirm attendence for ${name}?`);
            if (confirmed) {
                // If user clicks "Yes"
                console.log("User clicked Yes.");
                //If user clicks yes, show name label on the picture!
                responseLabel.innerText = `Hi ${name}`;
                //Call method for saving data to csv
                saveAttendance(name, id)

            } else {
                // If user clicks "No" or closes the dialogue
                console.log("User clicked No.");
                alert('Please check proper lighting and distance from the camera, Try again!');
            }
        }
        //User clicked Ok/yes
        async function saveAttendance(name, id) {
            const jsonData = {
                    name: name,
                    id: id
                }; // Your JSON data object
            const response = await fetch('/save_attendence_in_csv', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            });
            const responseData = await response.json();

            if(responseData){
                console.log(`${responseData.message}`);
                alert(`${responseData.message}`);

            }else{
                alert('Please try again!');
            }  
        }

    </script>

</body>
</html>